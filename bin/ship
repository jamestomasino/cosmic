#!/bin/sh

YELLOW="$(tput setaf 11)"
GREEN="$(tput setaf 10)"
RED="$(tput setaf 9)"
RESET="$(tput sgr0)"

main() {
  # who is running this script
  run_user=$(id -u)

  if [ "$run_user" -eq 0 ]; then
    # if running as root, check who sudoed and create ship for that user
    user="$SUDO_USER"

    # draw introduction
    printf "%sINITIALIZING QEC%s .. %sGOOD%s\\n" "$YELLOW" "$RESET" "$GREEN" "$RESET"
    printf "Connecting user [%s] .. %sGOOD%s\\n" "${YELLOW}${user}${RESET}" "$GREEN" "$RESET"
    printf "Request for new QEC node .. %sGOOD%s\\n" "$GREEN" "$RESET"
    printf "\\n"

    # prompt for ship name
    printf "Name of ship/outpost/colony? %s" "$GREEN"
    read -r shipname
    printf "%s" "$RESET"

    # if ship name is valid...
    if printf "%s" "$shipname" | grep -Eq "^[A-Za-z0-9]+[A-Za-z0-9\\.\\ \\-]+$"; then
      path="/var/gopher/${shipname}"
      ship_exists=$(find /var/gopher -maxdepth 1 -iname "$shipname") 

      # if ship does not already exist
      if [ -z "$ship_exists" ]; then
        printf "Attaching new node [%s]\\n" "${YELLOW}${shipname}${RESET}"

        # create ship directory in gopher and give ownership to user
        mkdir "$path"
        chmod 755 "$path"
        chown -R "$user" "$path"

        # create ship listings dir and link to ship gophermap
        mkdir "/var/gopher/ships/${shipname}"
        ln -s "/var/gopher/ships/ship/gophermap" "/var/gopher/ships/${shipname}/gophermap" 

        # create a symlink in user's home dir for easy access
        mkdir -p "/home/${user}/ships"
        ln -s "$path" "/home/${user}/ships/${shipname}"

        # notify user by email
        sed -e "s/username/${user}/g" -e "s/shipname/${shipname}/" /etc/templates/newship.tmpl | sendmail "$user"
        printf "Node registration .. %sSUCCESS%s\\n" "$GREEN" "$RESET"
      else
        owner=$(stat -c %U "$ship_exists")
        printf "%sABORT:%s A node by that name exists and is owned by %s\\n" "$RED" "$RESET" "$owner"
        exit 1
      fi
    else
      printf "%sABORT:%s ASCII letters, numbers, spaces and dashes only.\\n" "$RED" "$RESET"
      exit 1
    fi
  else
    exec sudo "$0"
  fi
}

main
