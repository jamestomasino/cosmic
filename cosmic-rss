#!/bin/sh

run_user=$(id -u)
if [ "$run_user" -eq 0 ]; then
  file_rss="/var/www/html/rss.xml"

  # Add header info to xml output
  {
    printf '<?xml version="1.0"?><rss version="2.0"><channel>'
    printf "\\n<title>Cosmic Voyage</title>\\n"
    printf "<link>gopher://cosmic.voyage</link>\\n"
    printf "<description>Messages from the human stellar diaspora</description>\\n"
    printf "<pubdate>%s</pubdate>\\n" "$(date +'%a, %d %b %Y %H:%M:%S')"
  } > "${file_rss}"

  # Loop through listings gophermap
  while read -r line; do
    log=$(printf "%s" "$line" | awk -F'\t' '{print $2}')
    title=$(printf "%s" "$line" | awk -F'\t' '{print $1}' | sed 's|^.||')
    owner=$(stat -c %U "/var/gopher${log}")

    # print item entry for each log
    {
      printf "<item>\\n"
      printf "  <title>%s</title>\\n" "$title"
      printf "  <author>%s</author>\\n" "$owner"
      printf "  <link>gopher://cosmic.voyage/0%s</link>\\n" "$log"
      printf "  <pubdate>%s</pubdate>\\n" "$(date -d "$(stat -c %y "/var/gopher${log}")" +'%a, %d %b %Y %H:%M:%S')"
      printf "  <description><![CDATA[<pre>\\n"
      cat "/var/gopher${log}"
      printf "</pre>]]></description>\\n"
      printf "</item>\\n"
    } >> "${file_rss}"
  done < "/var/gopher/listing.gophermap"

  # close up the footer
  {
    printf "</channel>\\n"
    printf "</rss>\\n"
  } >> "${file_rss}"
else
  printf "You must be root to run this script.\\n"
fi
